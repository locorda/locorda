@prefix crdt: <https://w3id.org/solid-crdt-sync/vocab/crdt-mechanics#> .
@prefix algo: <https://w3id.org/solid-crdt-sync/vocab/crdt-algorithms#> .
@prefix sync: <https://w3id.org/solid-crdt-sync/vocab/sync#> .
@prefix mc: <https://w3id.org/solid-crdt-sync/vocab/merge-contract#> .
@prefix idx: <https://w3id.org/solid-crdt-sync/vocab/idx#> .
@prefix mappings: <https://w3id.org/solid-crdt-sync/mappings/> .

# CRDT mappings for index documents (FullIndex, GroupIndexTemplate, GroupIndex)
# Used by framework for index metadata synchronization

<> a mc:DocumentMapping;
   # Import base CRDT framework
   mc:imports ( mappings:core-v1 ) ;
   # Define index-specific class mappings
   mc:classMapping ( <#full-index> <#group-index-template> <#group-index> <#indexed-property> <#grouping-rule> <#grouping-rule-property> <#modulo-hash-sharding> <#regex-transform> ) .

# FullIndex documents
<#full-index> a mc:ClassMapping;
   mc:appliesToClass idx:FullIndex;
   mc:rule
     [ mc:predicate idx:indexesClass; algo:mergeWith algo:Immutable ],
     [ mc:predicate idx:indexedProperty; algo:mergeWith algo:OR_Set ],
     [ mc:predicate idx:hasShard; algo:mergeWith algo:OR_Set ],
     [ mc:predicate idx:shardingAlgorithm; algo:mergeWith algo:Immutable ],
     [ mc:predicate idx:readBy; algo:mergeWith algo:OR_Set ] .

# GroupIndexTemplate documents
<#group-index-template> a mc:ClassMapping;
   mc:appliesToClass idx:GroupIndexTemplate;
   mc:rule
     [ mc:predicate idx:indexesClass; algo:mergeWith algo:Immutable ],
     [ mc:predicate idx:indexedProperty; algo:mergeWith algo:OR_Set ],
     [ mc:predicate idx:shardingAlgorithm; algo:mergeWith algo:Immutable ],
     [ mc:predicate idx:groupedBy; algo:mergeWith algo:Immutable ],
     [ mc:predicate idx:readBy; algo:mergeWith algo:OR_Set ],
     [ mc:predicate idx:populationState; algo:mergeWith algo:LWW_Register ],
     [ mc:predicate idx:hasPopulatingShard; algo:mergeWith algo:OR_Set ] .

# GroupIndex documents
<#group-index> a mc:ClassMapping;
   mc:appliesToClass idx:GroupIndex;
   mc:rule
     [ mc:predicate idx:basedOn; algo:mergeWith algo:Immutable ],
     [ mc:predicate idx:readBy; algo:mergeWith algo:OR_Set ],
     [ mc:predicate idx:populationState; algo:mergeWith algo:LWW_Register ] .

# IndexedProperty configuration objects within indices
<#indexed-property> a mc:ClassMapping;
   mc:appliesToClass idx:IndexedProperty;
   mc:rule
     [ mc:predicate idx:trackedProperty; algo:mergeWith algo:Immutable ],  # Which property to index
     [ mc:predicate idx:readBy; algo:mergeWith algo:OR_Set ] .      # Which installations read this property

# GroupingRule configuration for partitioned indices
<#grouping-rule> a mc:ClassMapping;
   mc:appliesToClass idx:GroupingRule;
   mc:rule
     [ mc:predicate idx:property; algo:mergeWith algo:OR_Set ],           # GroupingRuleProperty instances
     [ mc:predicate idx:groupTemplate; algo:mergeWith algo:Immutable ] .  # Template for group IRI construction

# GroupingRuleProperty configuration within grouping rules
# Identification key: (sourceProperty, hierarchyLevel) - both required for unique identification
<#grouping-rule-property> a mc:ClassMapping;
   mc:appliesToClass idx:GroupingRuleProperty;
   mc:rule
     [ mc:predicate idx:sourceProperty; algo:mergeWith algo:Immutable; mc:isIdentifying true ],  # Source property to extract from (identifying)
     [ mc:predicate idx:hierarchyLevel; algo:mergeWith algo:Immutable; mc:isIdentifying true ],  # Hierarchy level (identifying, default: 1)
     [ mc:predicate idx:transform; algo:mergeWith algo:Immutable ],       # Transform list (part of grouping identity)
     [ mc:predicate idx:missingValue; algo:mergeWith algo:LWW_Register ] . # Default value for missing properties

# ModuloHashSharding algorithm configuration
<#modulo-hash-sharding> a mc:ClassMapping;
   mc:appliesToClass idx:ModuloHashSharding;
   mc:rule
     [ mc:predicate idx:hashAlgorithm; algo:mergeWith algo:Immutable ],
     [ mc:predicate idx:numberOfShards; algo:mergeWith algo:Immutable ],
     [ mc:predicate idx:configVersion; algo:mergeWith algo:LWW_Register ],
     [ mc:predicate idx:autoScaleThreshold; algo:mergeWith algo:LWW_Register ] .

# RegexTransform configuration within transform lists
<#regex-transform> a mc:ClassMapping;
   mc:appliesToClass idx:RegexTransform;
   mc:rule
     [ mc:predicate idx:pattern; algo:mergeWith algo:LWW_Register ],       # Regex pattern (atomic within blank node)
     [ mc:predicate idx:replacement; algo:mergeWith algo:LWW_Register ] .  # Replacement template (atomic within blank node)